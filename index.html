<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>O-Licence Guard (Oxon Edition)</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Oxfordshire Logistics Blue */
            --company-primary: #0f172a; 
            --company-secondary: #3b82f6; 
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }
 
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-color); color: #1e293b; min-height: 100vh; padding-bottom: 80px; padding-top: env(safe-area-inset-top); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

        /* App Header */
        .app-header {
            background: white; border-bottom: 1px solid #e2e8f0; padding: 16px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }
        
        /* Status Banner */
        .status-banner {
            padding: 16px; margin: 16px 0; border-radius: var(--radius);
            display: flex; align-items: center; justify-content: space-between;
            font-weight: 700; color: white; transition: 0.3s;
        }
        .status-safe { background: var(--success); }
        .status-warn { background: var(--warning); color: #78350f; }
        .status-danger { background: var(--danger); }

        /* Tab Navigation */
        .tab-nav { background: white; border-bottom: 1px solid #e2e8f0; }
        .tab-buttons { display: flex; }
        .tab-btn {
            flex: 1; padding: 16px; border: none; background: none;
            font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; cursor: pointer;
        }
        .tab-btn.active { color: var(--company-primary); border-bottom-color: var(--company-primary); }
        .tab-content { display: none; padding: 20px 0; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid #e2e8f0; }
        .card h3 { font-size: 1rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

        /* Controls */
        .slider-group { margin-bottom: 24px; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
        .slider-val { font-weight: 700; color: var(--company-primary); }
        input[type=range] { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; outline: none; -webkit-appearance: none; appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: var(--company-primary); border: 3px solid white; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Shift Factor Grid */
        .factor-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .factor-btn {
            padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;
            text-align: center; cursor: pointer; transition: 0.2s; font-size: 0.9rem;
        }
        .factor-btn.active { border-color: var(--company-primary); background: #eff6ff; color: var(--company-primary); font-weight: 600; }
        
        /* Action Button */
        .action-btn {
            width: 100%; padding: 16px; background: var(--company-primary); color: white;
            border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .action-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        
        #chart-container { width: 100%; height: 280px; border-radius: 8px; background: white; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #64748b; }
        .guide-step { margin-bottom: 20px; border-left: 4px solid var(--company-secondary); padding-left: 15px; }
        .guide-step h3 { color: var(--company-primary); margin-bottom: 5px; font-size: 1.1rem; }
        .guide-step p { color: #475569; font-size: 0.95rem; line-height: 1.5; }

        @keyframes pulse-attention {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .note-attention { animation: pulse-attention 0.4s ease-out; }

        /* Mobile Nav */
        .mobile-menu-btn { display: none; font-size: 1.5rem; color: var(--company-primary); cursor: pointer; margin-left: auto; margin-right: 16px; }
        .mobile-nav-overlay { display: none; position: fixed; top: 60px; left: 0; width: 100%; background: white; border-bottom: 1px solid #e2e8f0; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 999; flex-direction: column; gap: 16px; }
        .mobile-nav-overlay a { text-decoration: none; color: #1e293b; font-weight: 600; font-size: 1.1rem; padding: 10px; border-radius: 6px; }
        .mobile-nav-overlay a:active { background: #f1f5f9; }

        @media (max-width: 768px) {
            .desktop-nav { display: none !important; }
            .mobile-menu-btn { display: block; }
            .app-header { padding: 12px 16px; }
            .factor-grid { grid-template-columns: 1fr; }
            input[type=range] { height: 12px; }
            input[type=range]::-webkit-slider-thumb { width: 28px; height: 28px; }
            .tab-btn { padding: 12px 8px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <div class="app-header">
        <div style="font-weight: 800; font-size: 1.1rem; color: var(--company-primary);">
            <i class="fas fa-truck-moving"></i> O-Licence Guard <span style="font-weight:400; opacity:0.7;">| Bicester</span>
        </div>
        
        <div class="mobile-menu-btn" onclick="toggleMobileMenu()">
            <i class="fas fa-bars"></i>
        </div>

        <div class="desktop-nav" style="display: flex; gap: 20px; margin-left: auto; margin-right: 20px;">
            <a href="#" onclick="showGuide()" style="text-decoration: none; color: #64748b; font-weight: 600; font-size: 0.9rem;">Guide</a>
            <a href="#" onclick="showSettings()" style="text-decoration: none; color: #64748b; font-weight: 600; font-size: 0.9rem;">Settings</a>
            <a href="#" onclick="showAbout()" style="text-decoration: none; color: #64748b; font-weight: 600; font-size: 0.9rem;">About</a>
        </div>
        <div style="font-size: 0.8rem; color: #64748b;">
            <i class="fas fa-wifi"></i> Online
        </div>
    </div>

    <div id="mobile-nav" class="mobile-nav-overlay">
        <a href="#" onclick="showGuide(); toggleMobileMenu()"><i class="fas fa-book" style="width:24px"></i> Guide</a>
        <a href="#" onclick="showSettings(); toggleMobileMenu()"><i class="fas fa-cog" style="width:24px"></i> Settings</a>
        <a href="#" onclick="showAbout(); toggleMobileMenu()"><i class="fas fa-info-circle" style="width:24px"></i> About</a>
    </div>

    <div class="container">
        <div class="status-banner status-safe" id="main-status-banner">
            <span><i class="fas fa-check-circle"></i> FIT TO DRIVE</span>
            <span id="safe-hours-badge">12h Window</span>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guide-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" onclick="closeGuide()">&times;</span>
            <h2 style="margin-bottom: 20px; color: var(--company-primary);"><i class="fas fa-book"></i> User Guide</h2>
            
            <div class="guide-step">
                <h3>1. Check Readiness</h3>
                <p>Adjust the sliders for <strong>Sleep</strong> and <strong>Alcohol</strong> to reflect your current state. The graph will show your predicted alertness levels.</p>
            </div>
            <div class="guide-step">
                <h3>2. Add Hazards</h3>
                <p>Go to the <strong>Local Hazards</strong> tab to select specific route stressors (e.g., A41 Congestion) or change your shift pattern.</p>
            </div>
            <div class="guide-step">
                <h3>3. Submit</h3>
                <p>If the status banner is green (Fit to Drive), proceed to the <strong>Submit</strong> tab to sign the declaration and log your check.</p>
            </div>
            
            <button class="action-btn" onclick="closeGuide()">Got it</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSettings()">&times;</span>
            <h2 style="margin-bottom: 20px; color: var(--company-primary);"><i class="fas fa-cog"></i> Settings</h2>
            
            <div class="guide-step">
                <h3>Appearance</h3>
                <p style="margin-bottom: 10px;">Choose your preferred interface theme.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="factor-btn active" id="theme-light" onclick="setTheme('light')" style="flex: 1;"><i class="fas fa-sun"></i> Light</button>
                    <button class="factor-btn" id="theme-dark" onclick="setTheme('dark')" style="flex: 1;"><i class="fas fa-moon"></i> Dark</button>
                </div>
            </div>
            
            <div class="guide-step">
                <h3>Notifications</h3>
                <label style="display:flex; gap:10px; align-items:center; cursor: pointer;">
                    <input type="checkbox" checked>
                    <span>Enable shift start reminders</span>
                </label>
            </div>
            
            <button class="action-btn" onclick="closeSettings()">Save Preferences</button>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAbout()">&times;</span>
            <h2 style="margin-bottom: 20px; color: var(--company-primary);"><i class="fas fa-info-circle"></i> About</h2>
            
            <div class="guide-step">
                <h3>O-Licence Guard <span style="font-size: 0.8em; opacity: 0.7; font-weight: normal;">v1.2.0</span></h3>
                <p><strong>Oxon Edition</strong></p>
                <p style="margin-top: 10px;">A proactive fleet compliance tool designed to manage driver readiness and local route hazards in real-time.</p>
            </div>

            <div class="guide-step">
                <h3>Key Features</h3>
                <ul style="margin-left: 20px; color: #475569; font-size: 0.95rem; line-height: 1.6;">
                    <li>Pre-shift readiness assessment</li>
                    <li>Predictive fatigue modeling</li>
                    <li>Local hazard integration (Bicester/A41)</li>
                    <li>Digital compliance declaration</li>
                </ul>
            </div>

            <div class="guide-step">
                <h3>Support</h3>
                <p>For technical support, contact the fleet manager.</p>
                <p style="margin-top: 5px; font-size: 0.85rem; color: #64748b;">&copy; 2025 O-Licence Guard.</p>
            </div>
            
            <button class="action-btn" onclick="closeAbout()">Close</button>
        </div>
    </div>

    <div class="tab-nav">
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('tab-check', this)">
                <i class="fas fa-clipboard-check"></i> Readiness
            </button>
            <button class="tab-btn" onclick="switchTab('tab-factors', this)">
                <i class="fas fa-map-marker-alt"></i> Local Hazards
            </button>
            <button class="tab-btn" onclick="switchTab('tab-report', this)">
                <i class="fas fa-paper-plane"></i> Submit
            </button>
        </div>
    </div>

    <div class="container">
        
        <div id="tab-check" class="tab-content active">
            <div class="card" style="padding: 10px;">
                <div id="chart-container"></div>
            </div>

            <div class="card">
                <h3><i class="fas fa-bed"></i> Pre-Shift Status</h3>
                
                <div class="slider-group">
                    <div class="slider-header">
                        <span>Sleep (Last 24h)</span>
                        <span class="slider-val" id="val-sleep">7.0 hrs</span>
                    </div>
                    <input type="range" id="input-sleep" min="0" max="12" step="0.5" value="7.0" oninput="updateEngine()" aria-label="Sleep hours">
                </div>

                <div class="slider-group">
                    <div class="slider-header">
                        <span>Alcohol Units (Last Night)</span>
                        <span class="slider-val" id="val-alcohol">0 units</span>
                    </div>
                    <input type="range" id="input-alcohol" min="0" max="20" step="1" value="0" oninput="updateEngine()" aria-label="Alcohol units">
                </div>

                <div class="slider-group">
                    <div class="slider-header">
                        <span>Hours Since Waking</span>
                        <span class="slider-val" id="val-awake">1.0 hrs</span>
                    </div>
                    <input type="range" id="input-awake" min="0" max="16" step="0.5" value="1.0" oninput="updateEngine()" aria-label="Hours since waking">
                </div>

                <div class="slider-group">
                    <div class="slider-header">
                        <span>Stress Level</span>
                        <span class="slider-val" id="val-stress">Low</span>
                    </div>
                    <input type="range" id="input-stress" min="0" max="2" step="1" value="0" oninput="updateEngine()" aria-label="Stress level">
                    <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#94a3b8; margin-top:4px;">
                        <span>Low</span>
                        <span>Medium</span>
                        <span>High</span>
                    </div>
                </div>
                <div id="readiness-note" style="margin-top: 20px; padding: 12px; background: #f0f9ff; border-left: 4px solid var(--company-secondary); border-radius: 4px; font-size: 0.85rem; color: #475569;">
                    <strong><i class="fas fa-info-circle"></i> Safe Driving Requirements:</strong><br>
                    Minimum 7 hours sleep, 0 alcohol units, and low stress are recommended for optimal alertness.
                </div>
            </div>
        </div>

        <div id="tab-factors" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-user-md"></i> Driver Condition</h3>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem; color: #64748b;">
                            <span>Current Readiness</span>
                            <span id="hazard-score-val" style="font-weight: 700; color: var(--company-primary);">--%</span>
                        </div>
                        <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div id="hazard-score-bar" style="width: 0%; height: 100%; background: var(--success); transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                    <div id="hazard-condition-text" style="font-weight: 600; font-size: 0.8rem; padding: 4px 10px; background: #f1f5f9; color: #64748b; border-radius: 4px; min-width: 80px; text-align: center;">
                        Calculating...
                    </div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-satellite-dish"></i> Live Conditions (Bicester)</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                    <div style="background: #f8fafc; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #e2e8f0;">
                        <div style="color: #64748b; font-size: 0.7rem; text-transform: uppercase; font-weight: 700;">Weather</div>
                        <div style="font-weight: 600; margin-top: 4px;"><i class="fas fa-cloud-rain" style="color: #64748b;"></i> Rain</div>
                    </div>
                    <div style="background: #f8fafc; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #e2e8f0;">
                        <div style="color: #64748b; font-size: 0.7rem; text-transform: uppercase; font-weight: 700;">Traffic</div>
                        <div style="font-weight: 600; margin-top: 4px; color: #f59e0b;"><i class="fas fa-car"></i> Heavy</div>
                    </div>
                    <div style="background: #f8fafc; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #e2e8f0;">
                        <div style="color: #64748b; font-size: 0.7rem; text-transform: uppercase; font-weight: 700;">Roadworks</div>
                        <div style="font-weight: 600; margin-top: 4px; color: #ef4444;"><i class="fas fa-cone"></i> A41</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-exclamation-triangle"></i> Route Stressors</h3>
                <p style="font-size:0.85rem; color:#64748b; margin-bottom:15px;">Select active hazards to calculate fatigue impact:</p>
                <div class="factor-grid" id="factor-grid">
                </div>
                
                <div id="factor-details" style="margin-top: 15px; padding: 12px; background: #f8fafc; border-radius: 6px; font-size: 0.9rem; display: none; border-left: 4px solid transparent; animation: fadeIn 0.3s;">
                    <strong id="factor-name-display" style="color: var(--company-primary);"></strong>
                    <p id="factor-desc-display" style="margin-top: 5px; color: #475569; font-size: 0.85rem; line-height: 1.4;"></p>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-clock"></i> Shift Pattern</h3>
                <div style="display:flex; gap:10px;">
                    <button class="factor-btn" style="flex:1" onclick="setShift('day', this)" id="btn-day">Day Run</button>
                    <button class="factor-btn" style="flex:1" onclick="setShift('night', this)" id="btn-night">Night Trunk</button>
                </div>
            </div>
        </div>

        <div id="tab-report" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-clipboard-list"></i> Shift Summary</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; font-weight: 700;">Physiology</div>
                        <div style="font-weight: 600; margin-top: 5px; color: #334155; font-size: 0.9rem;">
                            <i class="fas fa-bed" style="color: var(--company-secondary); width: 20px;"></i> <span id="sum-sleep">7h</span><br>
                            <i class="fas fa-wine-bottle" style="color: var(--company-secondary); width: 20px;"></i> <span id="sum-alcohol">0</span> Units
                        </div>
                    </div>
                    <div style="background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; font-weight: 700;">Shift Profile</div>
                        <div style="font-weight: 600; margin-top: 5px; color: #334155; font-size: 0.9rem;">
                            <i class="fas fa-clock" style="color: var(--company-secondary); width: 20px;"></i> <span id="sum-shift">Day</span><br>
                            <i class="fas fa-exclamation-triangle" style="color: var(--company-secondary); width: 20px;"></i> <span id="sum-hazards-count">0</span> Hazards
                        </div>
                    </div>
                </div>
                <div style="border-top: 1px solid #f1f5f9; padding-top: 12px;">
                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 8px; font-weight: 700;">SELECTED HAZARDS</div>
                    <div id="sum-hazards-list" style="display: flex; flex-wrap: wrap; gap: 6px;">
                        <!-- Badges -->
                    </div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-chart-bar"></i> Readiness History (7 Days)</h3>
                <div id="history-chart" style="width:100%; height:200px;"></div>
            </div>

            <div class="card">
                <h3><i class="fas fa-file-signature"></i> Final Declaration</h3>
                
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
                    <div>
                        <div style="font-size: 0.75rem; color: #0369a1; text-transform: uppercase; font-weight: 700;">Readiness Score</div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: #0284c7;" id="rep-score">95%</div>
                        <div id="rep-comparison" style="font-size: 0.75rem; font-weight: 600; margin-top: 6px; min-height: 20px;"></div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: #0369a1; text-transform: uppercase; font-weight: 700;">Safe Window</div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: #0284c7;" id="rep-window">12 Hours</div>
                    </div>
                </div>
                
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 0.85rem; color: #475569; border: 1px solid #e2e8f0;">
                    <label style="display:flex; gap:12px; align-items:start; cursor: pointer;">
                        <input type="checkbox" id="declaration-check" onchange="toggleSubmit()" style="margin-top: 3px;">
                        <span style="line-height: 1.4;">I declare that I am fit to drive, free from the influence of alcohol or drugs, and have reviewed the local hazards for this shift.</span>
                    </label>
                </div>
            </div>

            <button class="action-btn" id="btn-submit" disabled onclick="submitShift()">
                <i class="fas fa-paper-plane"></i> Submit Declaration
            </button>
        </div>

    </div>

    <script>
        // --- 1. BICESTER SPECIFIC CONFIGURATION ---
        const factors = [
            { id: 'a41', name: 'A41 Congestion', val: -15, icon: 'ðŸ›‘', type: 'neg', desc: 'Stop-start traffic on A41 significantly increases cognitive load and fatigue accumulation.' },
            { id: 'm40', name: 'M40 J9 Delay', val: -10, icon: 'ðŸš›', type: 'neg', desc: 'Junction 9 delays require heightened attention. Moderate impact on alertness.' },
            { id: 'village', name: 'Bicester Village Rush', val: -12, icon: 'ðŸ›ï¸', type: 'neg', desc: 'Heavy tourist traffic and unpredictable pedestrian movement requires high alertness.' },
            { id: 'warehouse', name: 'Warehouse Wait', val: -8, icon: 'â±ï¸', type: 'neg', desc: 'Long inactivity periods at depot can induce lethargy before driving.' },
            { id: 'rest', name: '45m Break', val: 20, icon: 'ðŸ…¿ï¸', type: 'pos', desc: 'Planned 45-minute rest break restores cognitive function and alertness.' },
            { id: 'coffee', name: 'Caffeine', val: 10, icon: 'â˜•', type: 'pos', desc: 'Caffeine provides a temporary boost to alertness (approx. 2-3 hours).' }
        ];

        // Load saved state
        const saved = JSON.parse(localStorage.getItem('olg_oxon_state')) || {};
        const history = JSON.parse(localStorage.getItem('olg_oxon_history')) || [];

        let state = {
            sleep: saved.sleep !== undefined ? saved.sleep : 7,
            alcohol: saved.alcohol !== undefined ? saved.alcohol : 0,
            awake: saved.awake !== undefined ? saved.awake : 1,
            stress: saved.stress !== undefined ? saved.stress : 0,
            isNight: saved.isNight !== undefined ? saved.isNight : false,
            activeFactors: saved.activeFactors || [],
            isCompliant: true,
            currentScore: 0,
            previousScore: history.length > 0 ? history[history.length - 1].score : 0
        };

        function handleKey(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                e.target.click();
            }
        }

        function showGuide() {
            document.getElementById('guide-modal').style.display = 'flex';
        }

        function closeGuide() {
            document.getElementById('guide-modal').style.display = 'none';
        }

        function showSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function showAbout() {
            document.getElementById('about-modal').style.display = 'flex';
        }

        function closeAbout() {
            document.getElementById('about-modal').style.display = 'none';
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeGuide();
                closeSettings();
                closeAbout();
            }
        });

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-nav');
            const isVisible = menu.style.display === 'flex';
            menu.style.display = isVisible ? 'none' : 'flex';
        }

        function setTheme(mode) {
            const root = document.documentElement;
            if (mode === 'dark') {
                root.style.setProperty('--bg-color', '#0f172a');
                root.style.setProperty('--card-bg', '#1e293b');
                root.style.setProperty('--company-primary', '#60a5fa');
                document.body.style.color = '#f1f5f9';
                document.getElementById('theme-light').classList.remove('active');
                document.getElementById('theme-dark').classList.add('active');
                Plotly.relayout('chart-container', {
                    paper_bgcolor: '#1e293b', plot_bgcolor: '#0f172a', font: { color: '#f1f5f9' }
                });
            } else {
                root.style.setProperty('--bg-color', '#f1f5f9');
                root.style.setProperty('--card-bg', '#ffffff');
                root.style.setProperty('--company-primary', '#0f172a');
                document.body.style.color = '#1e293b';
                document.getElementById('theme-light').classList.add('active');
                document.getElementById('theme-dark').classList.remove('active');
                Plotly.relayout('chart-container', {
                    paper_bgcolor: 'white', plot_bgcolor: '#f1f5f9', font: { color: '#1e293b' }
                });
            }
        }

        function saveData() {
            localStorage.setItem('olg_oxon_state', JSON.stringify({
                sleep: state.sleep,
                alcohol: state.alcohol,
                awake: state.awake,
                stress: state.stress,
                isNight: state.isNight,
                activeFactors: state.activeFactors
            }));
        }

        // --- 2. LOGIC ENGINE ---
        function updateEngine() {
            state.sleep = parseFloat(document.getElementById('input-sleep').value);
            state.alcohol = parseFloat(document.getElementById('input-alcohol').value);
            state.awake = parseFloat(document.getElementById('input-awake').value);
            state.stress = parseInt(document.getElementById('input-stress').value);

            // Base Alertness
            let baseScore = Math.min(100, (state.sleep / 8) * 100);
            let awakePenalty = Math.max(0, (state.awake - 2) * 5); // 5% drop per hour awake > 2h
            let stressPenalty = state.stress * 15; // 0, 15, 30

            // Factors
            let factorScore = 0;
            state.activeFactors.forEach(fid => {
                const f = factors.find(i => i.id === fid);
                factorScore += f.val;
            });

            let startScore = Math.max(0, Math.min(100, baseScore + factorScore - awakePenalty - stressPenalty));
            state.currentScore = startScore;

            // Generate Curve
            let x = [], y = [];
            let violationHour = null;
            let alcoholClearanceHour = state.alcohol; 

            for(let h=0; h<=15; h++) {
                x.push(h);
                let decay = state.isNight ? 5.5 : 3.5;
                let circadianPenalty = (state.isNight && h >= 4 && h <= 7) ? 15 : 0;
                let alcPenalty = (h < alcoholClearanceHour) ? 100 : 0;

                let score = startScore - (h * decay) - circadianPenalty - alcPenalty;
                score = Math.max(0, score);
                y.push(score);

                if(violationHour === null && score < 30) violationHour = h;
            }

            renderChart(x, y, violationHour, alcoholClearanceHour);
            updateUI(startScore, violationHour, alcoholClearanceHour);
            saveData();
        }

        // --- 3. RENDERERS ---
        function renderChart(x, y, violation, alcClear) {
            const trace1 = {
                x: x, y: y,
                mode: 'lines',
                fill: 'tozeroy',
                line: { color: state.isCompliant ? '#10b981' : '#ef4444', width: 3 },
                name: 'Alertness'
            };

            const trace2 = {
                x: [0, 15], y: [30, 30],
                mode: 'lines',
                line: { color: '#ef4444', width: 2, dash: 'dash' },
                name: 'Min Safe Limit'
            };

            const layout = {
                margin: { t: 10, r: 10, l: 30, b: 30 },
                height: 280,
                showlegend: false,
                xaxis: { title: 'Hours into Shift' },
                yaxis: { title: 'Fit Score', range: [0, 100] },
                paper_bgcolor: 'white',
                plot_bgcolor: '#f1f5f9',
                shapes: []
            };

            if(alcClear > 0) {
                layout.shapes.push({
                    type: 'rect',
                    xref: 'x', yref: 'paper',
                    x0: 0, x1: alcClear,
                    y0: 0, y1: 1,
                    fillcolor: 'rgba(239, 68, 68, 0.2)',
                    line: { width: 0 }
                });
            }

            Plotly.newPlot('chart-container', [trace1, trace2], layout, {displayModeBar: false});
        }

        function updateUI(score, violation, alcClear) {
            const banner = document.getElementById('main-status-banner');
            const badge = document.getElementById('safe-hours-badge');
            
            document.getElementById('val-sleep').innerText = state.sleep + " hrs";
            document.getElementById('val-alcohol').innerText = state.alcohol + " units";
            document.getElementById('val-awake').innerText = state.awake + " hrs";
            
            const stressLabels = ["Low", "Medium", "High"];
            document.getElementById('val-stress').innerText = stressLabels[state.stress];

            // Update Report Tab Summary
            document.getElementById('sum-sleep').innerText = state.sleep + "h";
            document.getElementById('sum-alcohol').innerText = state.alcohol;
            document.getElementById('sum-shift').innerText = state.isNight ? "Night Run" : "Day Run";
            document.getElementById('sum-hazards-count').innerText = state.activeFactors.length;
            
            const hazardList = document.getElementById('sum-hazards-list');
            if(hazardList) {
                hazardList.innerHTML = '';
                if(state.activeFactors.length === 0) {
                    hazardList.innerHTML = '<span style="font-size: 0.8rem; color: #94a3b8; font-style: italic;">No specific hazards selected</span>';
                } else {
                    state.activeFactors.forEach(fid => {
                        const f = factors.find(i => i.id === fid);
                        const badge = document.createElement('span');
                        badge.style.cssText = "font-size: 0.75rem; padding: 4px 8px; background: #e2e8f0; border-radius: 4px; color: #475569; font-weight: 600;";
                        badge.innerText = f.name;
                        hazardList.appendChild(badge);
                    });
                }
            }

            // Update Hazard Tab Visuals
            const hazardBar = document.getElementById('hazard-score-bar');
            const hazardVal = document.getElementById('hazard-score-val');
            const hazardText = document.getElementById('hazard-condition-text');
            
            if(hazardBar && hazardVal && hazardText) {
                if (alcClear > 0) {
                     hazardVal.innerText = "0%";
                     hazardBar.style.width = "100%";
                     hazardBar.style.background = "var(--danger)";
                     hazardText.innerText = "Unfit";
                     hazardText.style.background = "#fee2e2";
                     hazardText.style.color = "#991b1b";
                } else {
                    let displayScore = Math.round(score);
                    hazardVal.innerText = displayScore + "%";
                    hazardBar.style.width = displayScore + "%";
                    
                    if(displayScore >= 90) {
                        hazardBar.style.background = "var(--success)";
                        hazardText.innerText = "Optimal";
                        hazardText.style.background = "#dcfce7";
                        hazardText.style.color = "#166534";
                    } else if(displayScore >= 70) {
                        hazardBar.style.background = "var(--warning)";
                        hazardText.innerText = "Moderate";
                        hazardText.style.background = "#fef3c7";
                        hazardText.style.color = "#92400e";
                    } else {
                        hazardBar.style.background = "var(--danger)";
                        hazardText.innerText = "Critical";
                        hazardText.style.background = "#fee2e2";
                        hazardText.style.color = "#991b1b";
                    }
                }
            }

            const note = document.getElementById('readiness-note');
            
            // Animation Logic
            let currentNoteState = (state.sleep < 7 ? "sleep" : "") + (state.alcohol > 0 ? "alcohol" : "") + (state.stress > 0 ? "stress" : "");
            const prevNoteState = note.getAttribute('data-state') || "";
            if (currentNoteState !== prevNoteState) {
                note.setAttribute('data-state', currentNoteState);
                note.classList.remove('note-attention');
                void note.offsetWidth; // Trigger reflow
                note.classList.add('note-attention');
            }

            let issues = [];
            if (state.sleep < 7) issues.push(`Sleep < 7h (${state.sleep}h)`);
            if (state.alcohol > 0) issues.push(`Alcohol detected (${state.alcohol} units)`);
            if (state.stress > 0) issues.push(`Stress level is ${stressLabels[state.stress]}`);

            if (issues.length > 0) {
                note.style.background = "#fff1f2";
                note.style.borderLeftColor = "#e11d48";
                note.style.color = "#9f1239";
                note.innerHTML = `<strong><i class="fas fa-exclamation-circle"></i> Requirements Not Met:</strong><br>` + issues.join(', ');
            } else {
                note.style.background = "#f0f9ff";
                note.style.borderLeftColor = "var(--company-secondary)";
                note.style.color = "#475569";
                note.innerHTML = `<strong><i class="fas fa-check-circle"></i> Safe Driving Requirements:</strong><br>Minimum 7 hours sleep, 0 alcohol units, and low stress are recommended for optimal alertness.`;
            }

            if(alcClear > 0) {
                state.isCompliant = false;
                banner.className = 'status-banner status-danger';
                banner.innerHTML = `<span><i class="fas fa-ban"></i> INTOXICATED</span>`;
                badge.innerText = `Wait ${alcClear}h`;
                updateReport("0%", "0 Hours");
                return;
            }

            let safeHours = violation === null ? 15 : violation;
            
            if(safeHours < 9) {
                state.isCompliant = false;
                banner.className = 'status-banner status-warn';
                banner.innerHTML = `<span><i class="fas fa-exclamation-triangle"></i> FATIGUE RISK</span>`;
            } else {
                state.isCompliant = true;
                banner.className = 'status-banner status-safe';
                banner.innerHTML = `<span><i class="fas fa-check-circle"></i> FIT TO DRIVE</span>`;
            }
            badge.innerText = `${safeHours}h Safe Window`;
            
            updateReport(Math.round(score)+"%", safeHours+" Hours");
        }

        function updateReport(score, win) {
            document.getElementById('rep-score').innerText = score;
            document.getElementById('rep-window').innerText = win;
            
            // Comparison Logic
            const current = Math.round(state.currentScore);
            const prev = state.previousScore;
            const compEl = document.getElementById('rep-comparison');
            
            if(compEl) {
                if (prev === 0) {
                    compEl.innerHTML = '<span style="color: #64748b; background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px;">First Entry</span>';
                } else {
                    const diff = current - prev;
                    if (diff > 0) compEl.innerHTML = `<span style="color: #166534; background: #dcfce7; padding: 2px 6px; border-radius: 4px;">â–² ${diff}% Improvement</span>`;
                    else if (diff < 0) compEl.innerHTML = `<span style="color: #991b1b; background: #fee2e2; padding: 2px 6px; border-radius: 4px;">â–¼ ${Math.abs(diff)}% Decline</span>`;
                    else compEl.innerHTML = `<span style="color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">- No Change</span>`;
                }
            }
        }

        // --- 4. INTERACTIONS ---
        function initGrid() {
            const grid = document.getElementById('factor-grid');
            factors.forEach(f => {
                const btn = document.createElement('div');
                btn.className = 'factor-btn';
                btn.innerHTML = `<span class="factor-icon">${f.icon}</span>${f.name}`;
                btn.onclick = () => toggleFactor(f.id, btn);
                btn.setAttribute('tabindex', '0');
                btn.setAttribute('role', 'button');
                btn.setAttribute('aria-label', f.name);
                btn.onkeydown = handleKey;
                grid.appendChild(btn);
                
                // Restore active state
                if(state.activeFactors.includes(f.id)) {
                    btn.classList.add('active');
                }
            });
        }

        function toggleFactor(id, btn) {
            const details = document.getElementById('factor-details');
            const nameEl = document.getElementById('factor-name-display');
            const descEl = document.getElementById('factor-desc-display');
            const factor = factors.find(f => f.id === id);

            if(state.activeFactors.includes(id)) {
                state.activeFactors = state.activeFactors.filter(x => x !== id);
                btn.classList.remove('active');
                
                // Hide details if unclicking last item, or show previous
                if(state.activeFactors.length === 0) {
                    details.style.display = 'none';
                } else {
                    const lastId = state.activeFactors[state.activeFactors.length - 1];
                    const lastF = factors.find(f => f.id === lastId);
                    nameEl.innerText = lastF.name;
                    descEl.innerText = lastF.desc;
                    details.style.borderLeftColor = lastF.type === 'neg' ? '#ef4444' : '#10b981';
                }
            } else {
                state.activeFactors.push(id);
                btn.classList.add('active');
                
                // Show details
                details.style.display = 'block';
                nameEl.innerText = factor.name;
                descEl.innerText = factor.desc;
                details.style.borderLeftColor = factor.type === 'neg' ? '#ef4444' : '#10b981';
            }
            updateEngine();
        }

        function setShift(type, btn) {
            state.isNight = (type === 'night');
            document.querySelectorAll('#btn-day, #btn-night').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateEngine();
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            
            if(id === 'tab-check') {
                Plotly.Plots.resize('chart-container');
            } else if(id === 'tab-report') {
                renderHistoryChart();
            }
        }

        function renderHistoryChart() {
            const history = JSON.parse(localStorage.getItem('olg_oxon_history')) || [];
            const recent = history.slice(-6); // Last 6 entries
            
            let days = recent.map(h => new Date(h.date).toLocaleDateString(undefined, {weekday:'short'}));
            let yValues = recent.map(h => h.score);
            
            // Add Today
            days.push('Today');
            yValues.push(Math.round(state.currentScore));
            
            const colors = yValues.map(v => v >= 90 ? '#10b981' : v >= 70 ? '#f59e0b' : '#ef4444');

            const trace = {
                x: days, y: yValues, type: 'bar',
                marker: { color: colors },
                text: yValues.map(String), textposition: 'auto', hoverinfo: 'y'
            };

            const layout = {
                margin: { t: 10, r: 10, l: 30, b: 30 },
                height: 200,
                paper_bgcolor: getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim(),
                plot_bgcolor: 'rgba(0,0,0,0)',
                yaxis: { range: [0, 105], showgrid: true, gridcolor: '#e2e8f0' },
                font: { color: getComputedStyle(document.body).color }
            };

            Plotly.newPlot('history-chart', [trace], layout, {displayModeBar: false});
        }

        function toggleSubmit() {
            const checked = document.getElementById('declaration-check').checked;
            const btn = document.getElementById('btn-submit');
            btn.disabled = !checked || !state.isCompliant;
            
            if(!state.isCompliant) {
                btn.innerHTML = "<i class='fas fa-ban'></i> Cannot Submit (Non-Compliant)";
                btn.style.background = "#ef4444";
            } else {
                btn.innerHTML = "<i class='fas fa-paper-plane'></i> Submit Declaration";
                btn.style.background = "#0f172a";
            }
        }

        function submitShift() {
            const btn = document.getElementById('btn-submit');
            btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Logging...";
            setTimeout(() => {
                btn.innerHTML = "<i class='fas fa-check'></i> Sent to Dispatch";
                btn.style.background = "#10b981";
                
                // Save to history
                const record = {
                    date: new Date().toISOString(),
                    score: Math.round(state.currentScore)
                };
                const history = JSON.parse(localStorage.getItem('olg_oxon_history')) || [];
                history.push(record);
                localStorage.setItem('olg_oxon_history', JSON.stringify(history));
                
                state.previousScore = record.score;
            }, 1000);
        }

        function restoreUI() {
            document.getElementById('input-sleep').value = state.sleep;
            document.getElementById('input-alcohol').value = state.alcohol;
            document.getElementById('input-awake').value = state.awake;
            document.getElementById('input-stress').value = state.stress;
            
            if(state.isNight) document.getElementById('btn-night').classList.add('active');
            else document.getElementById('btn-day').classList.add('active');
        }

        restoreUI();
        initGrid();
        updateEngine();

    </script>
</body>
</html>
